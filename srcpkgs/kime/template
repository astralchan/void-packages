# Template file for 'kime'
pkgname=kime
version=2.5.6
revision=1
hostmakedepends="cmake cargo clang pkg-config llvm"
makedepends="
	$(vopt_if gtk2 gtk+-devel)
	$(vopt_if gtk3 gtk+3-devel)
	$(vopt_if gtk4 gtk4-devel)
	$(vopt_if qt5 qt5-devel)
	$(vopt_if qt6 qt6-base-devel)
	$(vopt_if xim xcb-util-devel)
	$(vopt_if xim cairo-devel)"
depends="
	$(vopt_if gtk2 gtk+)
	$(vopt_if gtk3 gtk+3)
	$(vopt_if gtk4 gtk4)
	$(vopt_if qt5 qt5)
	$(vopt_if qt6 qt6-base)
	$(vopt_if xim fontconfig)
	$(vopt_if xim freetype)
	$(vopt_if xim xcb-util)
	$(vopt_if xim cairo)"
short_desc="Korean IME"
maintainer="astralchan <astral@astralchan.xyz>"
license="GPL-3.0-or-later"
homepage="https://github.com/Riey/kime"
distfiles="https://github.com/Riey/kime/archive/refs/tags/v${version}.tar.gz"
checksum=e96ef7427b8ad64434c12e4e7c2c968e62f8efb98682a5887c72ba235ac3df3e

# Set build options
build_options="gtk2 gtk3 gtk4 qt5 qt6 wayland xim indicator candidate \
kime check"

# Set default options
build_options_default="gtk3 xim wayland indicator cadidate kime check"

do_build() {
	# TODO Fix opt builds
	KIME_CMAKE_ARGS="\
	-DENABLE_GTK2=$(vopt_if gtk2 ON OFF)\
	-DENABLE_GTK3=$(vopt_if gtk3 ON OFF)\
	-DENABLE_GTK4=$(vopt_if gtk4 ON OFF)\
	-DENABLE_QT5=$(vopt_if qt ON OFF)\
	-DENABLE_QT6=$(vopt_if qt6 ON OFF)"\
	KIME_MAKE_ARGS="${makejobs}"\
	KIME_BUILD_XIM="$(vopt_if xim 1 0)"\
	KIME_BUILD_WAYLAND="$(vopt_if wayland 1 0)"\
	KIME_BUILD_INDICATOR="$(vopt_if indicator 1 0)"\
	KIME_BUILD_KIME="$(vopt_if kime 1 0)"\
	KIME_BUILD_CANDIDATE_WINDOW="$(vopt_if candidate 1 0)"\
	KIME_BUILD_CHECK="$(vopt_if check 1 0)"\
	./scripts/build.sh
}

do_install() {
	./scripts/install.sh "${DESTDIR}"/usr
}

post_install() {
	if [ "${build_option_gtk2}" ]; then
		gtk-query-immodules-2.0 --update-cache
	fi
	if [ "${build_option_gtk3}" ]; then
		gtk-query-immodules-3.0 --update-cache
	fi
	if [ "${build_option_gtk4}" ]; then
		gio-querymodules /usr/lib/gtk-4.0/4.0.0/immodules
	fi
}

kime-devel_package() {
	short_desc+=" - developement files"
	do_install() {
		KIME_INSTALL_HEADER=1 ./scripts/install.sh "${PKGDESTDIR}"/usr
	}
}
